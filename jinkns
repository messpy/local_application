import tkinter as tk
from tkinter import filedialog
import os
import re
import xlwings as xw

def search_and_print(file_path, book):
    # ログファイルを開く
    with open(file_path, 'r', encoding='utf-8', errors='ignore') as file:
        content = file.read()
        lines = content.split('\n')

        # エクセルブックからC行とD行のワードを取得
        c_words = book.sheets[0].range('C:C').value
        d_words = book.sheets[0].range('D:D').value

        # 各行を検索
        for i, line in enumerate(lines):
            for c_word, d_word in zip(c_words, d_words):
                if c_word and c_word in line:
                    print_result(file_path, i + 1, "①", c_word, line)
                if d_word and d_word in line:
                    print_result(file_path, i + 1, "②", d_word, line)

def print_result(file_path, line_number, label, word, matched_line):
    print(f"ファイル名: {file_path}")
    print(f"行数({label}): {line_number}")
    print(f"{label}: {word}")
    print(f"当てはまった行: {matched_line}")
    print("\n")

def process_folder(folder_path, book):
    for root, dirs, files in os.walk(folder_path):
        for file in files:
            if file.endswith(".log"):
                file_path = os.path.join(root, file)
                print(f"\n開始: {file_path}")
                search_and_print(file_path, book)

def select_folder():
    root = tk.Tk()
    root.withdraw()

    folder_path = filedialog.askdirectory(title="フォルダを選択")
    if folder_path:
        book_path = filedialog.askopenfilename(title="エクセルファイルを選択", filetypes=[("Excel Files", "*.xlsx;*.xlsm")])
        if book_path:
            book = xw.Book(book_path)
            process_folder(folder_path, book)
            print("終了")

# フォルダとエクセルファイルを選択し、処理を開始
select_folder()